<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>URL Shortener - YOLO Edition</title>
</head>
<body>
    <h1>URL Shortener ðŸš€</h1>

    <form id="shortenForm">
        <label for="longUrl">Masukkan URL Panjang:</label>
        <input type="url" id="longUrl" required>
        <button type="submit">Perpendek URL</button>
    </form>

    <h2>URL yang Disingkat:</h2>
    <div id="shortenedUrl"></div>

    <script>
        const USERNAME = 'ZulfahmiFajri'; // Ganti dengan username GitHub-mu
        const REPO_NAME = 'My-Website'; // Ganti dengan nama repository
        const FILE_PATH = 'links.json';
        const TOKEN_GITHUB = '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'; // Masukkan Personal Access Token (PAT)

        async function fetchLinks() {
            const response = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`, {
                headers: { Authorization: `token ${TOKEN_GITHUB}` }
            });
            const data = await response.json();
            return { content: JSON.parse(atob(data.content)), sha: data.sha };
        }

        async function updateLinks(newLink) {
            const { content: links, sha } = await fetchLinks();
            const code = Math.random().toString(36).substring(2, 6);
            links[code] = newLink;

            const updateResponse = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`, {
                method: 'PUT',
                headers: {
                    Authorization: `token ${TOKEN_GITHUB}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Add new short link: ${code}`,
                    content: btoa(JSON.stringify(links, null, 2)),
                    sha: sha
                })
            });

            if (updateResponse.ok) {
                const shortUrl = `${window.location.origin}/shortener.html?code=${code}`;
                document.getElementById('shortenedUrl').innerHTML = `<p><a href="${shortUrl}" target="_blank">${shortUrl}</a></p>`;
            } else {
                alert('Gagal memperbarui links.json');
            }
        }

        document.getElementById('shortenForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const longUrl = document.getElementById('longUrl').value;
            updateLinks(longUrl);
        });

        async function redirectIfCodeExists() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');

            if (code) {
                const { content: links } = await fetchLinks();
                if (links[code]) {
                    window.location.href = links[code];
                } else {
                    document.body.innerHTML = '<h1>404: Link Tidak Ditemukan</h1>';
                }
            }
        }

        redirectIfCodeExists();
    </script>
</body>
</html>
